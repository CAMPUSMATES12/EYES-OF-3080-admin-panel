<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | EYES OF 3080</title>

l
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Segoe UI,Tahoma,sans-serif;
  background:#f4f6f5;
  color:#222;
}
header{
  background:linear-gradient(135deg,#2d5016,#4a7c2a);
  color:#fff;
}
.header-container{
  max-width:1200px;
  margin:auto;
  padding:16px 20px;
  display:flex;
  align-items:center;
  gap:12px;
}
.logo-img{width:38px;height:38px}
.logo-text{font-size:1.4rem;font-weight:bold}

.container{
  max-width:1000px;
  margin:30px auto;
  padding:0 20px;
}
h1{margin-bottom:20px;color:#2d5016}

.section{
  background:#fff;
  padding:22px;
  border-radius:14px;
  margin-bottom:25px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
}
.section h2{margin-bottom:15px;color:#2d5016}

input,textarea,select{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
textarea{min-height:90px}

button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  background:#2d5016;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:hover{opacity:.9}



</style>
</head>

<body>

<header>
  <div class="header-container">
    <img src="https://zvnovocoayqomdilidte.supabase.co/storage/v1/object/public/uploads/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpeg" class="logo-img">
    <span class="logo-text">EYES OF 3080 — Admin</span>
  </div>
</header>

<div class="container">
<h1>Dashboard</h1>

<!-- NEWS -->
<div class="section">
<h2>Publish News</h2>
<input id="newsTitle" placeholder="News title">
<input type="file" id="newsImage" accept="image/*">
<textarea id="newsContent" placeholder="News content"></textarea>
<button onclick="uploadNews()">Publish</button>
</div>

<!-- PDF / COURSE FILES -->
<div class="section">
  <h2>Upload Course PDF</h2>

  <!-- Course code (admin types only this) -->
<input
  id="courseCode"
  placeholder="Course Code (e.g BIO101)"
  onblur="loadCourseDetails()"
>

<input
  id="courseTitle"
  placeholder="Course Title"
>

<select id="courseLevel">
  <option value="">Select Level</option>
  <option value="100">100 Level</option>
  <option value="200">200 Level</option>
  <option value="300">300 Level</option>
  <option value="400">400 Level</option>
  <option value="500">500 Level</option>
</select>

  <input
    id="fileTitle"
    placeholder="File Title (e.g Lecture Notes)"
  >

  <input
    type="file"
    id="pdfFile"
    accept="application/pdf"
  >

  <button onclick="uploadCourseFile()">Upload PDF</button>
</div>

<!-- CBT -->
<div class="section">
<h2> Add CBT Question</h2>
<input id="cbtCourse" placeholder="Course code">
<textarea id="cbtQuestion" placeholder="Question"></textarea>
<input id="optA" placeholder="Option A">
<input id="optB" placeholder="Option B">
<input id="optC" placeholder="Option C">
<input id="optD" placeholder="Option D">
<select id="cbtAnswer">
<option value="A">A</option>
<option value="B">B</option>
<option value="C">C</option>
<option value="D">D</option>
</select>
<button onclick="addCBT()">Add Question</button>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://zvnovocoayqomdilidte.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bm92b2NvYXlxb21kaWxpZHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDM2OTgsImV4cCI6MjA3OTU3OTY5OH0.PcpwASQ3RBRoQVIglxKz-yM3iuYMZMtyQJBh8QNHad8"
);

/* ================= LOAD COURSE DETAILS ================= */
async function loadCourseDetails() {
  const code = document.getElementById("courseCode").value.trim().toUpperCase();
  const titleInput = document.getElementById("courseTitle");
  const levelSelect = document.getElementById("courseLevel");

  if (!code) return;

  const { data, error } = await supabaseClient
    .from("courses")
    .select("*")
    .eq("course_code", code)
    .single();

  if (data) {
    // Course exists
    titleInput.value = data.course_title;
    levelSelect.value = data.level || "";
    titleInput.readOnly = true;
    levelSelect.disabled = true;
  } else {
    // New course
    titleInput.value = "";
    levelSelect.value = "";
    titleInput.readOnly = false;
    levelSelect.disabled = false;
  }
}

/* ================= UPLOAD COURSE FILE ================= */
async function uploadCourseFile() {
  try {
    const courseCode = document.getElementById("courseCode").value.trim().toUpperCase();
    const courseTitle = document.getElementById("courseTitle").value.trim();
    const fileTitle = document.getElementById("fileTitle").value.trim();
    const file = document.getElementById("pdfFile").files[0];

    if (!courseCode || !courseTitle || !fileTitle || !file) {
      alert("Please fill all required fields");
      return;
    }

    // Upsert course using course_code as unique key
    const { data: course, error: courseError } = await supabaseClient
      .from("courses")
      .upsert(
        { course_code: courseCode, course_title: courseTitle },
        { onConflict: 'course_code' }
      )
      .select()
      .single();

    if (courseError) throw courseError;

    // Upload PDF to Supabase storage
    const fileName = `courses/${course.course_code}/${Date.now()}-${file.name}`;
    const { error: uploadError } = await supabaseClient
      .storage
      .from("uploads")
      .upload(fileName, file);

    if (uploadError) throw uploadError;

    const fileUrl = supabaseClient
      .storage
      .from("uploads")
      .getPublicUrl(fileName).data.publicUrl;

    // Save file record (without level)
    const { error: saveError } = await supabaseClient
      .from("course_files")
      .insert({
        course_code: course.course_code,
        title: fileTitle,
        file_url: fileUrl
      });

    if (saveError) throw saveError;

    alert("✅ PDF uploaded successfully");

    // Reset fields
    document.getElementById("fileTitle").value = "";
    document.getElementById("pdfFile").value = "";

  } catch (err) {
    console.error(err);
    alert("❌ PDF upload failed: " + err.message);
  }
}


/* ================= NEWS ================= */
async function uploadNews() {
  try {
    const title = document.getElementById("newsTitle").value.trim();
    const content = document.getElementById("newsContent").value.trim();
    const image = document.getElementById("newsImage").files[0];

    if (!title || !content) {
      alert("Title and content are required");
      return;
    }

    let imageUrl = null;

    if (image) {
      const fileName = `news/${Date.now()}-${image.name}`;
      const { error } = await supabaseClient.storage.from("uploads").upload(fileName, image);
      if (error) throw error;

      imageUrl = supabaseClient.storage.from("uploads").getPublicUrl(fileName).data.publicUrl;
    }

    const { error } = await supabaseClient.from("posts").insert({
      title,
      content,
      image_url: imageUrl
    });

    if (error) throw error;

    alert("✅ News published successfully");

    // Reset fields
    document.getElementById("newsTitle").value = "";
    document.getElementById("newsContent").value = "";
    document.getElementById("newsImage").value = "";

  } catch (err) {
    console.error(err);
    alert("❌ News upload failed: " + err.message);
  }
}

/* ================= CBT ================= */
async function addCBT() {
  try {
    const course = document.getElementById("cbtCourse").value.trim().toUpperCase();
    const question = document.getElementById("cbtQuestion").value.trim();
    const a = document.getElementById("optA").value.trim();
    const b = document.getElementById("optB").value.trim();
    const c = document.getElementById("optC").value.trim();
    const d = document.getElementById("optD").value.trim();
    const answer = document.getElementById("cbtAnswer").value;

    if (!course || !question || !a || !b || !c || !d) {
      alert("Fill all CBT fields");
      return;
    }

    const { error } = await supabaseClient.from("cbt_questions").insert({
      course,
      question,
      a, b, c, d,
      answer
    });

    if (error) throw error;

    alert("✅ CBT question added");

    // Reset fields
    document.getElementById("cbtCourse").value = "";
    document.getElementById("cbtQuestion").value = "";
    document.getElementById("optA").value = "";
    document.getElementById("optB").value = "";
    document.getElementById("optC").value = "";
    document.getElementById("optD").value = "";

  } catch (err) {
    console.error(err);
    alert("❌ CBT failed: " + err.message);
  }
}
</script>
</body>
</html>