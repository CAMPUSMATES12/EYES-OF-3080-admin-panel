<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel | EYES OF 3080</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
  font-family:Segoe UI,Tahoma,sans-serif;
  background:#f4f6f5;
  color:#222;
}
header{
  background:linear-gradient(135deg,#2d5016,#4a7c2a);
  color:#fff;
}
.header-container{
  max-width:1200px;
  margin:auto;
  padding:16px 20px;
  display:flex;
  align-items:center;
  gap:12px;
}
.logo-img{width:38px;height:38px}
.logo-text{font-size:1.4rem;font-weight:bold}

.container{
  max-width:1000px;
  margin:30px auto;
  padding:0 20px;
}
h1{margin-bottom:20px;color:#2d5016}

.section{
  background:#fff;
  padding:22px;
  border-radius:14px;
  margin-bottom:25px;
  box-shadow:0 4px 14px rgba(0,0,0,.08);
}
.section h2{margin-bottom:15px;color:#2d5016}

input,textarea,select{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
}
textarea{min-height:90px}

button{
  padding:10px 18px;
  border:none;
  border-radius:8px;
  background:#2d5016;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
button:hover{opacity:.9}

/* ================= NOTIFICATION CARD ================= */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #2d5016;
  color: #fff;
  padding: 16px 22px;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-width: 280px;
  max-width: 350px;
  z-index: 5000;
  opacity: 0;
  pointer-events: none;
  transition: all 0.4s ease;
}
.notification.show {
  opacity: 1;
  pointer-events: auto;
}
.notification.success { background: #2d7a2d; }
.notification.error { background: #c0392b; }
.notification.info { background: #2980b9; }
.notification .close-btn {
  background: none;
  border: none;
  font-size: 18px;
  color: #fff;
  cursor: pointer;
  margin-left: 12px;
}
</style>
</head>

<body>

<header>
  <div class="header-container">
    <img src="https://zvnovocoayqomdilidte.supabase.co/storage/v1/object/public/uploads/6a8f3e57-3d27-47f5-9b5e-22a7070fc442.jpeg" class="logo-img">
    <span class="logo-text">EYES OF 3080 â€” Admin</span>
  </div>
</header>

<div class="container">
<h1>Dashboard</h1>

<!-- ================= NOTIFICATION CARD ================= -->
<div id="notification" class="notification">
  <span id="notificationMessage">Notification text</span>
  <button class="close-btn" onclick="hideNotification()">Ã—</button>
</div>

<!-- ================= NOTIFICATIONS ================= -->
<div class="section">
  <h2>Send Notification</h2>
  <textarea id="notificationInput" placeholder="Type your notification here"></textarea>
  <select id="notificationType">
    <option value="success">Success</option>
    <option value="error">Error</option>
    <option value="info">Info</option>
  </select>
  <button onclick="sendNotification()">Publish Notification</button>
</div>

<!-- NEWS -->
<div class="section">
<h2>Publish News</h2>
<input id="newsTitle" placeholder="News title">
<input type="file" id="newsImage" accept="image/*">
<textarea id="newsContent" placeholder="News content"></textarea>
<button onclick="uploadNews()">Publish</button>
</div>

<!-- PDF / COURSE FILES -->
<div class="section">
  <h2>Upload Course PDF</h2>

  <input
    id="courseCode"
    placeholder="Course Code (e.g BIO101)"
    onblur="loadCourseDetails()"
  >

  <input
    id="courseTitle"
    placeholder="Course Title"
  >

  <select id="courseLevel">
    <option value="">Select Level</option>
    <option value="100">100 Level</option>
    <option value="200">200 Level</option>
    <option value="300">300 Level</option>
    <option value="400">400 Level</option>
    <option value="jupeb">JUPEB</option>
  </select>

  <input
    id="fileTitle"
    placeholder="File Title (e.g Lecture Notes)"
  >

  <input
    type="file"
    id="pdfFile"
    accept="application/pdf"
  >

  <button onclick="uploadCourseFile()">Upload PDF</button>
</div>


<!-- ================= CBT BULK UPLOAD ================= -->
<div class="section">
  <h2>Upload CBT Questions (CSV)</h2>

  <input
    id="cbtCsvCourse"
    placeholder="Course Code (e.g BIO101)"
  >

  <input
    id="cbtCsvLevel"
    placeholder="Level (e.g 100, 200, jupeb)"
  >

  <!-- NEW: FILE TITLE -->
  <input
    id="cbtCsvFileTitle"
    placeholder="File Title (e.g Reproduction, Genetics)"
  >

  <!-- File upload -->
  <input
    type="file"
    id="cbtCsvFile"
    accept=".csv"
  >

  <!-- âœ… NEW: Textarea for CSV text -->
  <textarea
    id="cbtCsvText"
    rows="10"
    cols="60"
    placeholder="Or paste CSV text here..."
    style="margin-top:10px;"
  ></textarea>

  <br>
  <button onclick="uploadCBTcsv()">Upload CSV</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ================= SUPABASE ================= */
const supabaseClient = supabase.createClient(
  "https://zvnovocoayqomdilidte.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp2bm92b2NvYXlxb21kaWxpZHRlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwMDM2OTgsImV4cCI6MjA3OTU3OTY5OH0.PcpwASQ3RBRoQVIglxKz-yM3iuYMZMtyQJBh8QNHad8"
);


/* ================= NOTIFICATION FUNCTIONS ================= */
function showNotification(message, type = "success") {
  const notif = document.getElementById("notification");
  const msg = document.getElementById("notificationMessage");
  msg.textContent = message;
  notif.className = `notification show ${type}`;
  setTimeout(() => {
    notif.classList.remove("show");
  }, 5000);
}

function hideNotification() {
  document.getElementById("notification").classList.remove("show");
}



/* ================= SIMPLE ADMIN JS ================= */
async function sendNotification() {
  try {
    const title = document.getElementById("notificationType").value || "Announcement";
    const message = document.getElementById("notificationInput").value.trim();

    if (!message) {
      alert("Please type a notification message");
      return;
    }

    // Insert notification into notifications table only
    const { data, error } = await supabaseClient
      .from("notifications")
      .insert([{ title, message }])
      .select()
      .maybeSingle(); // safer than single()

    if (error) throw error;

    alert("âœ… Notification posted successfully!");

    // Reset input
    document.getElementById("notificationInput").value = "";
    document.getElementById("notificationType").value = "announcement";

  } catch (err) {
    console.error(err);
    alert("âŒ Failed to post notification: " + err.message);
  }
}


/* ================= LOAD COURSE DETAILS ================= */
async function loadCourseDetails() {
  const code = document.getElementById("courseCode").value.trim().toUpperCase();
  const titleInput = document.getElementById("courseTitle");
  const levelSelect = document.getElementById("courseLevel");

  if (!code) return;

  const { data } = await supabaseClient
    .from("courses")
    .select("*")
    .eq("course_code", code)
    .single();

  if (data) {
    titleInput.value = data.course_title;
    levelSelect.value = data.level || "";
    titleInput.readOnly = true;
    levelSelect.disabled = true;
  } else {
    titleInput.value = "";
    levelSelect.value = "";
    titleInput.readOnly = false;
    levelSelect.disabled = false;
  }
}

/* ================= UPLOAD COURSE FILE ================= */
async function uploadCourseFile() {
  try {
    const courseCode = document.getElementById("courseCode").value.trim().toUpperCase();
    const courseTitle = document.getElementById("courseTitle").value.trim();
    const level = document.getElementById("courseLevel").value;
    const fileTitle = document.getElementById("fileTitle").value.trim();
    const file = document.getElementById("pdfFile").files[0];

    if (!courseCode || !courseTitle || !level || !fileTitle || !file) {
      showNotification("Please fill all fields", "error");
      return;
    }

    /* ðŸ”¹ UPSERT COURSE (LEVEL LIVES HERE) */
    const { data: course, error: courseError } = await supabaseClient
      .from("courses")
      .upsert(
        {
          course_code: courseCode,
          course_title: courseTitle,
          level: level
        },
        { onConflict: "course_code" }
      )
      .select()
      .single();

    if (courseError) throw courseError;

    /* ðŸ”¹ UPLOAD FILE */
    const fileName = `courses/${courseCode}/${Date.now()}-${file.name}`;
    const { error: uploadError } = await supabaseClient
      .storage
      .from("uploads")
      .upload(fileName, file);

    if (uploadError) throw uploadError;

    const fileUrl = supabaseClient
      .storage
      .from("uploads")
      .getPublicUrl(fileName).data.publicUrl;

    /* ðŸ”¹ SAVE FILE RECORD (NO LEVEL HERE) */
    const { error: fileError } = await supabaseClient
      .from("course_files")
      .insert({
        course_code: courseCode,
        title: fileTitle,
        file_url: fileUrl
      });

    if (fileError) throw fileError;

    showNotification("âœ… Course PDF uploaded successfully", "success");

    document.getElementById("fileTitle").value = "";
    document.getElementById("pdfFile").value = "";

  } catch (err) {
    console.error(err);
    showNotification("âŒ Upload failed: " + err.message, "error");
  }
}

/* ================= NEWS ================= */
async function uploadNews() {
  try {
    const title = document.getElementById("newsTitle").value.trim();
    const content = document.getElementById("newsContent").value.trim();
    const image = document.getElementById("newsImage").files[0];

    if (!title || !content) {
      showNotification("Title and content are required", "error");
      return;
    }

    let imageUrl = null;
    if (image) {
      const fileName = `news/${Date.now()}-${image.name}`;
      const { error } = await supabaseClient.storage.from("uploads").upload(fileName, image);
      if (error) throw error;
      imageUrl = supabaseClient.storage.from("uploads").getPublicUrl(fileName).data.publicUrl;
    }

    const { error } = await supabaseClient.from("posts").insert({
      title,
      content,
      image_url: imageUrl
    });

    if (error) throw error;

    showNotification("âœ… News published successfully", "success");

    document.getElementById("newsTitle").value = "";
    document.getElementById("newsContent").value = "";
    document.getElementById("newsImage").value = "";

  } catch (err) {
    console.error(err);
    showNotification("âŒ News upload failed: " + err.message, "error");
  }
}

/* ================= CBT ================= */
async function uploadCBTcsv() {
  try {
    const course = document.getElementById("cbtCsvCourse").value.trim().toUpperCase();
    let level = document.getElementById("cbtCsvLevel").value.trim();
    const fileTitle = document.getElementById("cbtCsvFileTitle")?.value.trim();
    const fileInput = document.getElementById("cbtCsvFile");
    const csvTextInput = document.getElementById("cbtCsvText")?.value.trim(); // optional pasted text

    // Validation
    if (!course || !fileTitle) {
      showNotification("Please fill course code and file title", "error");
      return;
    }

    // Get CSV content from pasted text OR uploaded file
    let csvContent = "";
    if (csvTextInput) {
      csvContent = csvTextInput;
    } else if (fileInput.files.length > 0) {
      csvContent = await fileInput.files[0].text();
    } else {
      showNotification("Please upload a CSV file or paste CSV text", "error");
      return;
    }

    // AUTO GET LEVEL IF EMPTY
    if (!level) {
      const { data, error } = await supabaseClient
        .from("courses")
        .select("level")
        .eq("course_code", course)
        .single();

      if (error || !data?.level) {
        showNotification("Level not found for this course. Please enter it manually.", "error");
        return;
      }
      level = data.level;
    }

    // PARSE CSV
    const rows = csvContent.split("\n").map(r => r.trim()).filter(Boolean);
    const questions = [];

    rows.forEach((row, index) => {
      const cols = row.split(",").map(c => c.trim());
      if (cols.length < 5) return; // Require question + 4 options + answer

      const questionText = cols[0];
      const optionA = cols[1];
      const optionB = cols[2];
      const optionC = cols[3];
      const optionD = cols[4];
      const correctAnswer = cols[5] || optionA; // fallback to first option if missing

      questions.push({
        course_code: course,
        level,
        file_title: fileTitle,
        question: questionText,
        option_a: optionA,
        option_b: optionB,
        option_c: optionC,
        option_d: optionD,
        correct_option: correctAnswer
      });
    });

    if (questions.length === 0) {
      showNotification("No valid questions found in CSV/text", "error");
      return;
    }

    // SAVE TO SUPABASE
    const { error } = await supabaseClient
      .from("cbt_questions")
      .insert(questions);

    if (error) throw error;

    showNotification(`âœ… ${questions.length} CBT questions uploaded successfully`, "success");

    // RESET INPUTS
    document.getElementById("cbtCsvCourse").value = "";
    document.getElementById("cbtCsvLevel").value = "";
    document.getElementById("cbtCsvFileTitle").value = "";
    document.getElementById("cbtCsvFile").value = "";
    if (document.getElementById("cbtCsvText")) {
      document.getElementById("cbtCsvText").value = "";
    }

  } catch (err) {
    console.error(err);
    showNotification("âŒ Failed to upload CSV/text: " + err.message, "error");
  }
}
</script>
</body>
</body>
</html>