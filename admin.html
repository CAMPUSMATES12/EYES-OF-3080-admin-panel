<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EYES OF 3080 Admin Panel</title>
  <link rel="icon" type="image/png" href="https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo">
  <style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins', sans-serif; }
  body { background:#f1fdf5; color:#0a5a2b; }
  header { display:flex; align-items:center; justify-content:center; padding:15px 20px; background:#0a5a2b; color:#fff; }
  header img { height:50px; border-radius:50%; margin-right:10px; }
  header h1 { font-size:1.5rem; }
  nav { display:flex; justify-content:center; margin:20px 0; flex-wrap:wrap; }
  nav button { background:#33cc99; color:#fff; padding:10px 20px; border:none; margin:5px; border-radius:50px; cursor:pointer; transition:0.3s; }
  nav button.active, nav button:hover { background:#0a5a2b; }
  main { max-width:900px; margin:0 auto; padding:20px; }
  .tab-content { display:none; }
  .tab-content.active { display:block; }
  form { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); margin-bottom:30px; position:relative; }
  input, textarea { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
  button.save-btn { background:#33cc99; color:#fff; padding:12px 20px; border:none; border-radius:50px; cursor:pointer; transition:0.3s; }
  button.save-btn:hover { background:#0a5a2b; }
  .item-list { margin-top:20px; }
  .item { background:#fff; padding:20px; margin:10px 0; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; }
  .item-actions button { margin-left:10px; padding:8px 16px; border:none; border-radius:50px; cursor:pointer; font-weight:600; }
  .item-actions .edit-btn { background:#33cc99; color:#fff; }
  .item-actions .delete-btn { background:#ff4d4d; color:#fff; }
  .file-preview { margin:10px 0; max-height:200px; border-radius:8px; object-fit:cover; display:block; }
  .drop-zone { padding:20px; border:2px dashed #0a5a2b; border-radius:12px; text-align:center; color:#666; margin:10px 0; cursor:pointer; position:relative; }
  .drop-zone.dragover { background:rgba(0,90,43,0.1); border-color:#155e36; color:#0a5a2b; }
  .drop-zone input[type=file] { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  #popupMessage { position: fixed; top: 20px; right: 20px; background: #0a5a2b; color: #fff; padding: 12px 20px; border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); transition: all 0.4s ease; z-index: 9999; }
  #popupMessage.show { opacity: 1; transform: translateY(0); }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>

<header>
  <img src="https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo" alt="Logo">
  <h1>EYES OF 3080 Admin Panel</h1>
</header>

<nav>
  <button onclick="openTab('home')" class="active">Home</button>
  <button onclick="openTab('campus')">Campus Gist</button>
  <button onclick="openTab('academic')">Academic Updates</button>
  <button onclick="openTab('marketplace')">Marketplace</button>
  <button onclick="openTab('pdfs')">PDFs</button>
  <button onclick="openTab('history')">History</button>
  <button onclick="openTab('maintenance')">Maintenance</button>
 <button onclick="openTab('pdfPayments')">💳 PDF Payments</button>
</nav>

<main>
  <!-- HOME -->
  <div id="home" class="tab-content active">
    <h2>Manage Home Content</h2>
    <form id="homeForm">
      <input type="hidden" id="homeId">
      <input type="text" id="homeTitle" placeholder="Title" required>
      <textarea id="homeContent" placeholder="Content" rows="4" required></textarea>
      <input type="date" id="homeDate" required>
      <div class="drop-zone" id="homeDropZone">
        Drag & drop an image or click to select
        <input type="file" id="homeFile">
      </div>
      <img id="homePreview" class="file-preview" src="" alt="">
      <button type="submit" class="save-btn">Save</button>
    </form>
    <div class="item-list" id="homeList"></div>
  </div>

<!-- 💳 PDF PAYMENT MANAGEMENT -->
<div id="pdfPayments" class="tab-content">
  <h2 style="color:#006400;">💳 Manage PDF Payments</h2>

  <!-- Payment Form -->
  <form id="paymentForm" style="margin-top:15px;">
    <input type="hidden" id="paymentId">

    <div style="display:flex; flex-wrap:wrap; gap:10px;">
      <input type="text" id="paymentFullName" placeholder="Full Name" required style="flex:1; min-width:200px;">
      <input type="email" id="paymentEmail" placeholder="Email" required style="flex:1; min-width:200px;">
    </div>

    <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:10px;">
      <input type="text" id="paymentTransactionId" placeholder="Transaction ID" required style="flex:1; min-width:200px;">
      <input type="number" id="paymentAmount" placeholder="Amount (₦)" value="500" required style="flex:1; min-width:200px;">
    </div>

    <select id="paymentStatus" required style="margin-top:10px; width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
      <option value="">-- Select Status --</option>
      <option value="pending">Pending</option>
      <option value="verified">Verified ✅</option>
    </select>

    <!-- Optional Proof Upload -->
    <div class="drop-zone" id="proofDropZone" style="margin-top:12px;">
      📎 Upload proof (optional)
      <input type="file" id="paymentProof" accept="image/*,application/pdf">
    </div>
    <img id="proofPreview" class="file-preview" src="" alt="">

    <button type="submit" class="save-btn" style="
      margin-top:12px;
      background:#006400;
      color:white;
      padding:10px 20px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;">💾 Save / Update Payment</button>
  </form>

  <!-- Payment List -->
  <div id="paymentList" class="item-list" style="margin-top:25px;">
    <h3 style="color:#006400;">📋 All PDF Payments</h3>
    <p style="font-size:14px; color:#555;">View, verify, or manage user payments below.</p>
  </div>
</div>

  <!-- CAMPUS -->
  <div id="campus" class="tab-content">
    <h2>Manage Campus Gist</h2>
    <form id="campusForm">
      <input type="hidden" id="campusId">
      <input type="text" id="campusTitle" placeholder="Title" required>
      <textarea id="campusContent" placeholder="Content" rows="4" required></textarea>
      <div class="drop-zone" id="campusDropZone">
        Drag & drop an image or click to select
        <input type="file" id="campusFile">
      </div>
      <img id="campusPreview" class="file-preview" src="" alt="">
      <button type="submit" class="save-btn">Save</button>
    </form>
    <div class="item-list" id="campusList"></div>
  </div>

  <!-- ACADEMIC -->
  <div id="academic" class="tab-content">
    <h2>Manage Academic Updates</h2>
    <form id="academicForm">
      <input type="hidden" id="academicId">
      <input type="text" id="academicTitle" placeholder="Title" required>
      <textarea id="academicContent" placeholder="Content" rows="4" required></textarea>
      <div class="drop-zone" id="academicDropZone">
        Drag & drop an image or click to select
        <input type="file" id="academicFile">
      </div>
      <img id="academicPreview" class="file-preview" src="" alt="">
      <button type="submit" class="save-btn">Save</button>
    </form>
    <div class="item-list" id="academicList"></div>
  </div>

  <!-- MARKETPLACE -->
  <div id="marketplace" class="tab-content">
    <h2>Manage Marketplace</h2>
    <form id="marketForm">
      <input type="hidden" id="marketId">
      <input type="text" id="marketTitle" placeholder="Item Name" required>
      <input type="text" id="marketPrice" placeholder="Price" required>
      <div class="drop-zone" id="marketDropZone">
        Drag & drop an image or click to select
        <input type="file" id="marketFile">
      </div>
      <img id="marketPreview" class="file-preview" src="" alt="">
      <button type="submit" class="save-btn">Save</button>
    </form>
    <div class="item-list" id="marketList"></div>
  </div>

  <!-- PDF -->
  <div id="pdfs" class="tab-content">
    <h2>Manage PDFs</h2>
    <form id="pdfForm">
      <input type="hidden" id="pdfId">
      <input type="text" id="pdfTopic" placeholder="Topic" required>
      <input type="text" id="pdfLevel" placeholder="Level (e.g. 100L)">
      <div class="drop-zone" id="pdfDropZone">
        Drag & drop a PDF or click to select
        <input type="file" id="pdfFile" accept="application/pdf" required>
      </div>
      <div id="pdfPreview" class="file-preview" style="display:none;"></div>
      <button type="submit" class="save-btn">Save</button>
    </form>
    <div class="item-list" id="pdfList"></div>
  </div>

  <!-- HISTORY -->
  <div id="history" class="tab-content">
    <h2>History Log</h2>
    <ul id="historyList"></ul>
  </div>

  <!-- MAINTENANCE -->
  <div id="maintenance" class="tab-content">
    <h2>Maintenance Mode</h2>
    <form id="maintenanceForm">
      <label>
        <input type="checkbox" id="maintenanceToggle">
        Enable Maintenance Mode
      </label>
      <br><br>
      <button type="submit" class="save-btn">Save</button>
    </form>
  </div>
</main>

<!-- Popup -->
<div id="popupMessage">✅ Saved successfully!</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
/* ============================
   SUPABASE CONNECTION
============================ */
const SUPABASE_URL = "https://vtpsruejncfykiazrfsx.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ0cHNydWVqbmNmeWtpYXpyZnN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3NDA5NzQsImV4cCI6MjA3MjMxNjk3NH0.UV55gbsSAgnyolxJhIYTaJUpvoJFsJn0_-LMNwhwAK0";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ============================
   ELEMENTS
============================ */
const paymentForm = document.getElementById("paymentForm");
const paymentList = document.getElementById("paymentList");

/* ============================
   LOAD PAYMENTS
============================ */
async function loadPayments() {
  try {
    const { data, error } = await client
      .from("pdf_access")
      .select("*")
      .order("created_at", { ascending: false });

    if (error) throw error;

    if (!data.length) {
      paymentList.innerHTML = "<p style='color:#555;'>No payments found yet.</p>";
      return;
    }

    paymentList.innerHTML = data
      .map(payment => `
        <div id="payment-${payment.id}" class="payment-card" style="
          border:1px solid ${payment.verified ? '#00b894' : '#ff9800'};
          border-radius:8px;
          padding:15px;
          margin:10px 0;
          background:#fff;">
          <strong style="color:#006400;">${payment.full_name || "Unnamed User"}</strong><br>
          <span>Email:</span> ${payment.email}<br>
          <span>Txn ID:</span> ${payment.transaction_id || "N/A"}<br>
          <span>Amount:</span> ₦${payment.amount || 500}<br>
          <span>Status:</span> 
            <b id="status-${payment.id}" style="color:${payment.verified ? '#00b894' : '#ff9800'};">
              ${payment.verified ? "Verified ✅" : "Pending ⏳"}
            </b><br>
          ${payment.proof_url ? `<a href="${payment.proof_url}" target="_blank" style="color:#006400;">📎 View Proof</a><br>` : ""}
          ${payment.verified_at ? `<small style="color:#555;">✔ Verified at ${new Date(payment.verified_at).toLocaleString()}</small><br>` : ""}
          <div style="margin-top:8px;">
            ${!payment.verified
              ? `<button onclick="changePaymentStatus(${payment.id},'verified')" 
                   id="verifyBtn-${payment.id}"
                   style="background:#006400;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">
                   Verify ✅</button>`
              : `<button onclick="changePaymentStatus(${payment.id},'pending')" 
                   style="background:#ff9800;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">
                   Mark Pending</button>`}
            <button onclick="deletePayment(${payment.id})" 
              style="background:#b00020;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;margin-left:5px;">
              🗑 Delete
            </button>
          </div>
        </div>
      `)
      .join("");
  } catch (err) {
    console.error("❌ Error loading payments:", err);
    paymentList.innerHTML = "<p style='color:red;'>Failed to load payments.</p>";
  }
}

/* ============================
   CHANGE PAYMENT STATUS
============================ */
async function changePaymentStatus(id, status) {
  // ensure id is integer
  id = parseInt(id);

  let updateObj = {};

  switch(status) {
    case 'pending':
      updateObj = { paid: false, verified: false, verified_at: null };
      break;
    case 'verified':
      updateObj = { paid: true, verified: true, verified_at: new Date().toISOString() };
      break;
    default:
      console.error('Unknown status', status);
      return;
  }

  try {
    const { data, error } = await client
      .from("pdf_access")
      .update(updateObj)
      .eq("id", id)
      .select(); // return updated row for confirmation

    if (error) throw error;
    if (!data || data.length === 0) throw new Error("No row updated. Check if ID exists.");

    // ✅ update UI
    const verified = updateObj.verified === true;
    updatePaymentCardUI(id, verified);

  } catch(err) {
    console.error("❌ Failed to update status", err);
    alert("❌ Failed to update status: " + err.message);
  }
}

/* ============================
   DELETE PAYMENT
============================ */
async function deletePayment(id) {
  if (!confirm(`🗑 Are you sure you want to delete this payment?`)) return;

  try {
    const { error } = await client
      .from("pdf_access")
      .delete()
      .eq("id", id);

    if (error) throw error;

    const card = document.getElementById(`payment-${id}`);
    if (card) card.remove();
  } catch (err) {
    console.error("❌ Delete error:", err);
    alert("❌ Could not delete payment: " + err.message);
  }
}

/* ============================
   UPDATE CARD UI
============================ */
function updatePaymentCardUI(id, verified) {
  const card = document.getElementById(`payment-${id}`);
  const status = document.getElementById(`status-${id}`);
  const button = document.getElementById(`verifyBtn-${id}`);

  if (card && status) {
    card.style.borderColor = verified ? "#00b894" : "#ff9800";
    status.textContent = verified ? "Verified ✅" : "Pending ⏳";
    status.style.color = verified ? "#00b894" : "#ff9800";
  }

  if (button) {
    button.outerHTML = verified
      ? `<button onclick="changePaymentStatus(${id},'pending')" style="background:#ff9800;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Mark Pending</button>`
      : `<button onclick="changePaymentStatus(${id},'verified')" id="verifyBtn-${id}" style="background:#006400;color:#fff;border:none;padding:5px 10px;border-radius:5px;cursor:pointer;">Verify ✅</button>`;
  }
}

/* ============================
   ADD / UPDATE PAYMENT
============================ */
paymentForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const full_name = document.getElementById("paymentFullName").value.trim();
  const email = document.getElementById("paymentEmail").value.trim();
  const transaction_id = document.getElementById("paymentTransactionId").value.trim();
  const amount = parseInt(document.getElementById("paymentAmount").value);
  const status = document.getElementById("paymentStatus").value;

  const paid = status === "verified";
  const verified = status === "verified";

  try {
    const { error } = await client.from("pdf_access").upsert({
      email,
      full_name,
      transaction_id,
      amount,
      paid,
      verified,
      verified_at: verified ? new Date().toISOString() : null,
      updated_at: new Date().toISOString(),
    });

    if (error) throw error;
    alert("✅ Payment saved successfully!");
    paymentForm.reset();
    loadPayments();
  } catch (err) {
    console.error("❌ Error saving payment:", err);
    alert("❌ Failed to save payment: " + err.message);
  }
});

/* ============================
   REAL-TIME AUTO UPDATE
============================ */
client
  .channel("pdf_access-changes")
  .on(
    "postgres_changes",
    { event: "*", schema: "public", table: "pdf_access" },
    (payload) => {
      console.log("📡 Realtime update:", payload);
      loadPayments();
    }
  )
  .subscribe();

/* ============================
   INITIAL LOAD
============================ */
document.addEventListener("DOMContentLoaded", loadPayments);

// Upload
async function uploadFile(file, section) {
  try {
    let uploadFile = file;
    if (/image\/(png|jpeg|jpg)/i.test(file.type)) {
      uploadFile = await addWatermark(file);
    }
    const fileName = `${section}/${Date.now()}-${file.name}`;
    const { error } = await client.storage.from("uploads").upload(fileName, uploadFile);
    if (error) throw error;
    const { data } = client.storage.from("uploads").getPublicUrl(fileName);
    return data.publicUrl;
  } catch (err) {
    console.error("❌ File upload failed:", err);
    showPopup("❌ File upload failed!");
    return null;
  }
}

// Watermark for images
async function addWatermark(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        const logo = new Image();
        logo.crossOrigin = "anonymous";
        logo.src = "https://vtpsruejncfykiazrfsx.supabase.co/storage/v1/object/public/PRODUCTS/EYES%20OF%203080%20logo";
        logo.onload = () => {
          const logoWidth = img.width * 0.25; 
          const logoHeight = (logo.height / logo.width) * logoWidth;
          ctx.globalAlpha = 0.85;
          ctx.drawImage(logo, img.width - logoWidth - 20, img.height - logoHeight - 20, logoWidth, logoHeight);
          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: "image/png" }));
          }, "image/png");
        };
        logo.onerror = reject;
      };
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// Popup
function showPopup(msg="✅ Saved successfully!"){
  const popup=document.getElementById("popupMessage");
  popup.textContent=msg;
  popup.classList.add("show");
  setTimeout(()=>popup.classList.remove("show"),2500);
}

// Tabs
function openTab(tabId){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.querySelector(`nav button[onclick="openTab('${tabId}')"]`).classList.add('active');
  if(tabId === "history") loadHistory();
  if(tabId === "pdfs") loadItems("pdf");
}

// Drop Zones
function setupDropZone(dropId,fileId,previewId){
  const dz=document.getElementById(dropId);
  const fileInput=document.getElementById(fileId);
  const preview=previewId?document.getElementById(previewId):null;
  dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
  dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
  dz.addEventListener('drop', e => {
    e.preventDefault(); dz.classList.remove('dragover');
    fileInput.files = e.dataTransfer.files;
    if(preview && fileInput.files[0]){
      preview.textContent = fileInput.files[0].name;
      preview.style.display = 'block';
    }
  });
  fileInput.addEventListener('change', ()=> {
    if(preview && fileInput.files[0]){
      preview.textContent = fileInput.files[0].name;
      preview.style.display = 'block';
    }
  });
}
['home','campus','academic','market','pdf'].forEach(id=>{
  const previewId = id!=='pdf' ? id+'Preview' : "pdfPreview";
  setupDropZone(id+'DropZone',id+'File',previewId);
});

// Save / Edit
async function handleSave(section){
  const form=document.getElementById(section+'Form');
  const id=document.getElementById(section+'Id').value;
  let fileUrl=null;

  if(section==="pdf"){
    const topic=document.getElementById("pdfTopic").value;
    const level=document.getElementById("pdfLevel").value;
    const fileInput=document.getElementById("pdfFile");
    if(fileInput.files[0]) fileUrl=await uploadFile(fileInput.files[0], section);

    if(id){
      const updates={topic, level};
      if(fileUrl) updates.pdf_url=fileUrl;
      await client.from("pdf").update(updates).eq("id", id);
      await logHistory("pdf","update",topic);
    } else {
      const newItem={topic, level};
      if(fileUrl) newItem.pdf_url=fileUrl;
      await client.from("pdf").insert(newItem);
      await logHistory("pdf","add",topic);
    }
    loadItems("pdf");
  } else {
    const title=document.getElementById(section+'Title').value;
    const content=document.getElementById(section+'Content')?.value || '';
    const date=document.getElementById(section+'Date')?.value || null;
    const fileInput=document.getElementById(section+'File');
    if(fileInput && fileInput.files[0]) fileUrl=await uploadFile(fileInput.files[0], section);

    if(id){
      const updates={title, content};
      if(date) updates.date=date;
      if(fileUrl) updates.image_url=fileUrl;
      await client.from(section).update(updates).eq("id", id);
      await logHistory(section,"update",title);
    } else {
      const newItem={title, content};
      if(date) newItem.date=date;
      if(fileUrl) newItem.image_url=fileUrl;
      await client.from(section).insert(newItem);
      await logHistory(section,"add",title);
    }
    loadItems(section);
  }
  form.reset();
  const preview=document.getElementById(section==="pdf"? "pdfPreview":section+'Preview');
  if(preview) preview.style.display='none';
  showPopup("✅ Saved successfully!");
}

// Load items
async function loadItems(section){
  const list=document.getElementById(section+'List');
  const { data } = await client.from(section==="pdf"?"pdf":section).select('*').order('id',{ascending:false});
  list.innerHTML='';
  if(!data||data.length===0){ list.innerHTML="<p>No items yet.</p>"; return; }
  data.forEach(item=>{
    const div=document.createElement('div');
    div.className='item';
    if(section==="pdf"){
      div.innerHTML=`
        <div class="item-details">
          <strong>${item.topic}</strong> (${item.level||""})<br>
          ${item.pdf_url?`<a href="${item.pdf_url}" target="_blank">📄 View PDF</a>`:""}
        </div>
        <div class="item-actions">
          <button class="edit-btn" onclick="editItem('pdf',${item.id})">Edit</button>
          <button class="delete-btn" onclick="deleteItem('pdf',${item.id},'${item.topic}')">Delete</button>
        </div>`;
    } else {
      div.innerHTML=`
        <div class="item-details">
          <strong>${item.title}</strong>${item.date? ` (${item.date})` : ''}<br>
          ${item.content||''}
          ${item.image_url ? `<br><img src="${item.image_url}" style="max-height:150px; margin-top:5px; border-radius:6px;">` : ''}
        </div>
        <div class="item-actions">
          <button class="edit-btn" onclick="editItem('${section}',${item.id})">Edit</button>
          <button class="delete-btn" onclick="deleteItem('${section}',${item.id},'${item.title}')">Delete</button>
        </div>`;
    }
    list.appendChild(div);
  });
}

// Edit
async function editItem(section,id){
  const { data } = await client.from(section).select('*').eq('id', id).single();
  document.getElementById(section+'Id').value=data.id;
  if(section==="pdf"){
    document.getElementById("pdfTopic").value=data.topic;
    document.getElementById("pdfLevel").value=data.level;
    if(data.pdf_url){
      const preview=document.getElementById("pdfPreview");
      preview.textContent="📄 Existing PDF";
      preview.style.display='block';
    }
  } else {
    document.getElementById(section+'Title').value=data.title;
    if(document.getElementById(section+'Content')) document.getElementById(section+'Content').value=data.content;
    if(document.getElementById(section+'Date')) document.getElementById(section+'Date').value=data.date||'';
    if(data.image_url){
      const preview=document.getElementById(section+'Preview');
      if(preview){ preview.src=data.image_url; preview.style.display='block'; }
    }
  }
}

// Delete
async function deleteItem(section,id,title){
  if(!confirm('Are you sure?')) return;
  await client.from(section).delete().eq('id',id);
  await logHistory(section,"delete",title);
  loadItems(section);
  showPopup("🗑️ Deleted successfully!");
}

// History
async function logHistory(section, action, title) {
  await client.from("history").insert([{ section, action, title }]);
}
async function loadHistory() {
  const list = document.getElementById("historyList");
  const { data } = await client.from("history").select("*").order("id", { ascending: false }).limit(50);
  list.innerHTML = "";
  if (!data || data.length === 0) {
    list.innerHTML = "<li>No history yet...</li>";
    return;
  }
  data.forEach(h => {
    const li = document.createElement("li");
    li.textContent = `${new Date(h.timestamp).toLocaleString()} → ${h.action.toUpperCase()} "${h.title}" in ${h.section}`;
    list.appendChild(li);
  });
}

// ✅ MAINTENANCE FUNCTIONS
  async function loadMaintenance() {
    const { data } = await client.from("settings").select("maintenance_mode").eq("id",1).single();
    if (data) document.getElementById("maintenanceToggle").checked = data.maintenance_mode;
  }
  document.getElementById("maintenanceForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const mode = document.getElementById("maintenanceToggle").checked;
    await client.from("settings").upsert({ id: 1, maintenance_mode: mode });
    showPopup("⚡ Maintenance mode updated!");
  });

// Attach
['home','campus','academic','market','pdf'].forEach(section=>{
  document.getElementById(section+'Form').addEventListener('submit',e=>{
    e.preventDefault();
    handleSave(section);
  });
  loadItems(section);
});
</script>
</body>
</html>